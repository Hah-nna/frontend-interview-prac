# TCP 3 way handshake란 무엇인지 설명해주실 수 있을까요?

TCP는 신뢰성을 확보할 때 3-way-handshake라는 작업을 진행함

1. SYN(Synchronize: 연결 요청 플래그) 단계
   클라이언트는 서버에 TCP 연결을 요청하기 위해 클라이언트의 ISN(초기 네트워크 연결을 할 때 할당된 32비트의 고유 시퀀스 번호)을 담아 보냄.

2. SYN + ACK(Acknowledgment: 응답 플래그) 단계
   서버는 클라이언트의 SYN을 수신하고, 서버의 ISN을 보내며 승인번호로 클라이언트 SYN + 1을 보냄(서버가 클라이언트의 syn를 받았음을 의미함)

3. ACK 단계
   클라이언트는 서버의 ISN + 1한 값인 승인 번호를 담아 ACK를 서버로 보냄(클라이언트는 서버의 SYN + ACK를 받았음을 알려주기 위해 ACK를 서버로 보냄) -> 3-way-handshake 완료 -> 연결 성립

이런 3-way-handshake 과정 이후 신뢰성 구축 -> 데이터 전송 시작.
TCP는 이 과정을 거치기 때문에 신뢰성이 있는 계층이라고 하며, UDP는 이 과정을 거치지 않기 때문에 신뢰성이 없는 계층이라고 함

#### TCP 연결 해제 과정

TCP가 연결을 해제할 때는 4-way-handshake 과정이 필요함
클라이언트와 서버 간 주고받을 데이터가 더이상 없을 때 양쪽에서 연결을 안전하게 종료하기 위해서 사용함.

1. 클라이언트가 연결 종료 요청을 보냄
   클라이언트가 연결을 종료하려고 할 때, FIN(종료 요청) 플래그를 설정한 세그먼트를 서버에게 보냄. 그리고 클라이언트는 FIN_WAIT_1 상태로 진입하고, 서버의 응답을 기다림

2. 서버가 클라이언트의 연결 종료 요청에 응답함
   서버는 FIN 패킷을 받고 해당 연결에 대한 데이터를 모두 보냈다는 것을 ACK(응답 확인) 플래그를 설정한 세그먼트를 클라이언트에게 보냄. 이로써 서버는 클라이언트의 연결 종료 요청을 확인하고, CLOSE_WAIT 상태로 진입함. 클라이언트는 ACK를 받으면 FIN_WAIT_2 상태로 진입함

3. 서버가 연결 종료를 위한 작업을 수행함
   서버는 데이터 전송이 완료되면 자신의 FIN 패킷을 클라이언트에게 전송하고 LAST_ACK 상태로 진입함. 이로써 서버는 클라이언트의 연결 종료 요청에 응답하며, 자신도 연결 종료를 요청하는 상태가 됨

4. 클라이언트가 서버의 연결 종료 요청에 응답함
   클라이언트는 서버로부터 온 FIN 세그먼트에 대한 ACK를 보냄. 이로써 클라이언트는 CLOSED 상태로 진입하고, 연결이 완전히 종료됨. 서버는 ACK를 받으면 CLOSED 상태가 됨. 클라이언트도 CLOSED 상태가 되기 전에 일정 시간동안 TIME_WAIT 상태에서 대기하여 이전 연결에서 발생할 수 있는 문제가 없는지 확인함.

근데 연결을 바로 닫으면 되지 왜 일정 시간 뒤에 닫을까?

1. 지연 패킷이 발생할 경우를 대비하기 위해서
   패킷이 뒤늦게 도달하고 이를 처리하지 못한다면 데이터 무결성 문제\*가 발생함
   ex: 전체 데이터가 100개인데 50개만 들어오는 경우

2. 두 장치가 연결이 닫혔는지 확인하기 위해서
   만약 LAST_ACK 상태에서 닫히게 되면 새로운 연결을 하려고 할 때 장치는 계속 LAST_ACK로 되어있기 때문에 접속 오류가 나타나게 됨

때문에 TIME_WAIT\*라는 기다리는 시간이 필요함

\*TIME_WAIT

- 소켓이 바로 소멸되지 않고 일정 시간 유지되는 상태를 말함
- 지연 패킷 등의 문제점을 해결하는 데 사용됨
- os 마다 시간은 다름

\*데이터 무결성
데이터의 정확성과 일관성을 유지하고 보증하는 것

---

3-way-handshake는 TCP에서 데이터를 주고받기 전에 3-way-handshake 과정을 거쳐야 합니다.

1. 연결 요청 단계: 클라이언트가 서버에 연결을 요청하며, 고유한 시작 번호를 보냅니다.
2. 연결 수락 단계: 서버는 요청을 받아들이고 자신의 고유한 시작 번호와 클라이언트의 시작 번호+1을 한 값을 보냅니다.
3. 수락 확인 단계: 클라이언트는 서버의 시작 번호+1한 값을 보내 연결이 성공했음을 알립니다.
   이렇게 3단계 과정을 거쳤을 때 연결이 성립되며, 데이터를 안전하게 주고받을 수 있습니다. 반면, UDP는 이 과정 없이 바로 데이터를 보내기 때문에, 데이터가 도착했는지 확인하기 어렵습니다. 그래서, TCP는 신뢰성 있는 서비스를 제공하는 반면, UDP는 신뢰성이 떨어지는 서비스라고 말합니다.

4-way-handshake는 서버와 클라이언트 간 주고 받을 데이터가 없을 때 양쪽의 연결을 안정적으로 종료하기 위해서 사용합니다.

1. 연결 종료 요청
   클라이언트는 종료 요청을 서버에 보내고 클라이언트는 서버의 응답을 기다리는 상태로 전환됩니다

2. 서버의 확인 응답
   서버는 클라이언트의 요청을 수신하고 모든 데이터를 처리한 후 확인 응답을 클라이언트에게 전달합니다. 클라이언트는 이를 받고 대기 상태로 전환됩니다

3. 서버의 연결 종료 요청
   서버는 종료 요청을 클라이언트에게 보냅니다. 서버는 클라이언트의 마지막 확인 응답을 기다립니다. 동시에 서버는 일정 시간 동안 대기 상태로 전환하여 이전 연결에서 발생할 수 있는 문제가 있는지 없는지 확인합니다

4. 클라이언트의 최종 응답
   클라이언트는 서버의 종료 요청을 확인하고 확인 응답을 서버에 보냅니다. 이로써 연결이 완전이 종료됩니다
